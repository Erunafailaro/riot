<?xml version="1.0" encoding="UTF-8"?>
<beans
	xmlns="http://www.springframework.org/schema/beans"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:override="http://www.riotfamily.org/schema/common/override"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
		http://www.springframework.org/schema/util
		http://www.springframework.org/schema/util/spring-util-2.5.xsd
		http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
		http://www.riotfamily.org/schema/common/override
		http://www.riotfamily.org/schema/common/override-8.0.xsd">

	<!-- FilterPlugin to collect request statistics -->
	<bean id="requestCountFilterPlugin" class="org.riotfamily.statistics.web.RequestCountFilterPlugin">
		<property name="filterName" value="website-filter" />
        <property name="enabled" value="${riot.statistics.request.enabled=false}" />
        <property name="ignoreUploads" value="${riot.statistics.request.ignoreUploads=false}" />
        		        
        <!-- Requests with response times slower than 10000 ms are logged -->
        <property name="warnThreshold" value="${riot.statistics.request.warnThreshold=10000}" />

        <!-- When max. number of parallel requests is exceeded a failure is signaled to the monitoring system -->
        <property name="maxRequests" value="${riot.statistics.request.maxRequests=500}" />
        
        <!-- URL called by the monitoring system to ensure system health -->
        <property name="monitoredUrl" value="${riot.statistics.request.monitoredUrl=/status/application}" />
        
        <!-- Response status codes which should be monitored -->
        <property name="faultStatusCodes" value="${riot.statistics.request.faultStatusCodes=404,500}" />
    </bean>

	<bean id="requestTimestampRenderer" class="org.riotfamily.common.web.ui.DateRenderer">
		<property name="pattern" value="dd.MM.yy HH:mm:ss" />
	</bean>
	
    <!-- ================================================================== -->
    <!-- Module resources                                                   -->
    <!-- ================================================================== -->
        
    <override:add ref="resourceMappings" append="true">         
        <bean class="org.riotfamily.core.resource.ResourceMapping">
            <property name="path" value="/" />
            <property name="location" value="classpath:/org/riotfamily/statistics/runtime/resources/" />
        </bean>
    </override:add>    
        
    <override:add ref="messageBasenames" append="true">
		<value>classpath:/org/riotfamily/statistics/runtime/i18n/messages</value>
	</override:add>
    
    <override:add ref="customStyleSheets">
        <value>style/riot-statistics.css</value>
    </override:add>
     
 	<util:list id="packageListPatterns">
 		<value>org.riotfamily.*</value>
		<value>org.springframework.*</value>
		<value>org.hibernate.*</value>
		<value>java.*</value>
 	</util:list>
 	
 	<util:list id="statsColumns">
		<bean class="org.riotfamily.core.screen.list.ColumnConfig">
			<property name="property" value="name" />
		</bean>
		<bean class="org.riotfamily.core.screen.list.ColumnConfig">
			<property name="property" value="value" />
		</bean>
	</util:list>
 	
 	<override:add ref="systemScreens">
		
		<bean id="systemStatistics" class="org.riotfamily.core.screen.GroupScreen">
			<property name="icon" value="chart_curve" />
			<property name="childScreens">
				<list>
					<bean id="properties" class="org.riotfamily.core.screen.GroupScreen">
						<property name="childScreens">
							<list>	
					        	<bean id="systemProperties" class="org.riotfamily.core.screen.list.TreeListScreen">
						        	<property name="icon" value="table_gear" />
						        	<property name="dao">
										<bean class="org.riotfamily.statistics.dao.SystemPropertiesDao" />
									</property>
									<property name="columns" ref="statsColumns" />
					        	</bean>
					        	<bean id="environmentProperties" class="org.riotfamily.core.screen.list.TreeListScreen">
					        		<property name="icon" value="picture" />
					        		<property name="dao">
										<bean class="org.riotfamily.statistics.dao.EnvironmentPropertiesDao" />
									</property>
									<property name="columns" ref="statsColumns" />
					        	</bean>
					        	<bean id="applicationProperties" class="org.riotfamily.core.screen.list.TreeListScreen">
					        		<property name="icon" value="cog" />
					        		<property name="dao">
					        			<bean class="org.riotfamily.statistics.dao.ResourcePropertiesDao">
								        	<property name="resource" value="classpath:/application.properties" />
        								</bean>
        							</property>
        							<property name="columns" ref="statsColumns" />
					        	</bean>
					        </list>
				       </property>
					</bean>
					
			        <bean id="riotModuleVersions" class="org.riotfamily.core.screen.list.TreeListScreen">
			        	<property name="icon" value="plugin" />
			        	<property name="dao">
			        		<bean class="org.riotfamily.statistics.dao.PackageListDao">
        						<property name="patterns" ref="packageListPatterns" />
        					</bean>
       					</property>
			        	<property name="columns" ref="statsColumns" />
				    </bean>
				    
				    <bean id="hibernateStatistics" class="org.riotfamily.core.screen.GroupScreen">
						<property name="icon" value="hibernate" />
						<property name="childScreens">
							<list>
					        	<bean id="hibernateCommonStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
					        		<property name="icon" value="chart_bar" />
					        		<property name="dao">
					        			<bean class="org.riotfamily.statistics.dao.HibernateStatisticsDao">
					        				<constructor-arg ref="sessionFactory" />
					        			</bean>
					        		</property>
					        		<property name="columns" ref="statsColumns" />
					        	</bean>
					        	<bean id="hibernateCacheStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
					        		<property name="dao">
					        			<bean class="org.riotfamily.statistics.dao.HibernateCacheStatisticsDao">
					        				<constructor-arg ref="sessionFactory" />
					        			</bean>
					        		</property>
					        		<property name="columns" ref="statsColumns" />
					        	</bean>
					        	<bean id="hibernateCacheRegions" class="org.riotfamily.core.screen.list.TreeListScreen">
					        		<property name="dao">
					        			<bean class="org.riotfamily.statistics.dao.HibernateCacheRegionDao">
					        				<constructor-arg ref="sessionFactory" />
					        			</bean>
					        		</property>
					        		<property name="icon" value="map" />
					        	</bean>
							</list>
						</property>
					</bean>
			        
			        <bean id="connectionPoolStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
			        	<property name="icon" value="database_connect" />
					    <property name="dao">
					    	<bean class="org.riotfamily.statistics.dao.C3P0StatisticsDao">
		        				<property name="dataSource" ref="riotDataSource" />
		        			</bean>
		        		</property>
		        		<property name="columns" ref="statsColumns" />
			        </bean>
			        
			        <bean id="runtimeStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
			        	<property name="icon" value="server_chart" />
			        	<property name="dao">
			        		<bean class="org.riotfamily.statistics.dao.RuntimeStatisticsDao" />
			        	</property>
			        	<property name="columns" ref="statsColumns" />
			        </bean>
			        
			        <bean id="requestStatistics" class="org.riotfamily.core.screen.GroupScreen">
						<property name="childScreens">
							<list>
						        <bean id="requestOverviewStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
						        	<property name="icon" value="chart_bar" />
						        	<property name="dao">
						        		<bean class="org.riotfamily.statistics.dao.RequestStatisticsDao">
						        			<constructor-arg ref="requestCountFilterPlugin" />
						        		</bean>
						        	</property>
						        	<property name="columns" ref="statsColumns" />
						        </bean>
					            <bean id="requestCriticalStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
					            	<property name="icon" value="hourglass" />
					            	<property name="dao">
					            		<bean class="org.riotfamily.statistics.dao.CriticalRequestStatisticsDao">
					            			<constructor-arg ref="requestCountFilterPlugin" />
					            		</bean>
						        	</property>
						        </bean>
						        <bean id="requestCurrentStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
						        	<property name="icon" value="time" />
						        	<property name="dao">
						        		<bean class="org.riotfamily.statistics.dao.CurrentRequestStatisticsDao">
						        			<constructor-arg ref="requestCountFilterPlugin" />
						        		</bean>
						        	</property>
						        </bean>
						        <bean id="requestFaultyStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
						        	<property name="icon" value="error" />
						        	<property name="dao">
						        		<bean class="org.riotfamily.statistics.dao.FaultyResponsesStatisticsDao">
						        			<constructor-arg ref="requestCountFilterPlugin" />
						        		</bean>
						        	</property>
						        </bean>
							</list>
						</property>
					</bean>
				        
			   		<bean id="cachiusStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
						<property name="dao">
							<bean class="org.riotfamily.statistics.dao.CachiusStatisticsDao">
								<property name="cacheService" ref="cacheService" />
							</bean>
						</property>
						<property name="columns" ref="statsColumns" />
					</bean>
				</list>
			</property>
		</bean>
	</override:add>
		
	<!--
    
    <list:list id="connection-pool-statistics" order-by="name" row-style-property="style">
        <list:dao class="org.riotfamily.statistics.dao.C3P0StatisticsDao">
        	<list:property name="dataSource" ref="riotDataSource" />
        </list:dao>
        <list:columns>
            <list:column property="name"  />
            <list:column property="value" />
        </list:columns>
        <list:command id="refresh" />  
    </list:list>
    
    <list:list id="hibernate-common-statistics" order-by="" row-style-property="style">
        <list:dao class="org.riotfamily.statistics.dao.HibernateStatisticsDao" />
        <list:command class="org.riotfamily.statistics.commands.ToggleHibernateStatisticsCommand" />  
        <list:command class="org.riotfamily.statistics.commands.ClearHibernateStatisticsBaselineCommand" />  
        <list:command id="refresh" />  
    </list:list>
    
    <list:list id="hibernate-cache-statistics" order-by="" row-style-property="style">
        <list:dao class="org.riotfamily.statistics.dao.HibernateCacheStatisticsDao" />
        <list:command id="refresh" />  
    </list:list>
    
    <list:list id="hibernate-cache-regions" order-by="">
        <list:dao class="org.riotfamily.statistics.dao.HibernateCacheRegionDao" />
        <list:columns>
            <list:column property="name" sortable="true" />
            <list:column property="elementsInMemory" sortable="true" />
            <list:column property="elementsOnDisk" sortable="true" />
            <list:column property="hitCount" sortable="true" />
            <list:column property="missCount" sortable="true" />
            <list:column property="putCount" sortable="true" />
            <list:column property="kbInMemory" sortable="true" />
        </list:columns>
        <list:command id="refresh" />  
    </list:list>

    <list:list id="runtime-statistics" order-by="" row-style-property="style">
        <list:dao class="org.riotfamily.statistics.dao.RuntimeStatisticsDao" />
        <list:columns>
            <list:column property="name" />
            <list:column property="value" />
        </list:columns>
        <list:command class="org.riotfamily.statistics.commands.PerformGarbageCollectionCommand" /> 
        <list:command id="refresh" />  
    </list:list>
    
     <list:list id="cachius-statistics" order-by="" row-style-property="style">
        <list:dao class="org.riotfamily.statistics.dao.CachiusStatisticsDao">
        	<list:property name="cacheService" ref="cacheService" />
        </list:dao>
        <list:columns>
            <list:column property="name" />
            <list:column property="value" />
        </list:columns>
        <list:command id="refresh" />  
        <list:command class="org.riotfamily.statistics.commands.ResetCachiusStatisticsCommand" />
        <list:command class="org.riotfamily.statistics.commands.InvalidateCachiusCacheCommand" />
    </list:list>
    
  
    <list:list id="request-overview-statistics" order-by="" row-style-property="style">
        <list:dao class="org.riotfamily.statistics.dao.RequestStatisticsDao" />
        <list:columns>
            <list:column property="name" />
            <list:column property="value" />
        </list:columns>
        <list:command class="org.riotfamily.statistics.commands.ToggleRequestStatisticsCommand" />  
        <list:command class="org.riotfamily.statistics.commands.ClearRequestStatisticsBaselineCommand" />  
        <list:command id="refresh" />  
    </list:list>

    <list:list id="request-critical-statistics" order-by="responseTime desc" search="name">
        <list:dao class="org.riotfamily.statistics.dao.CriticalRequestStatisticsDao" />
        <list:columns>
            <list:column property="name" />
            <list:column property="timestamp" />
            <list:column property="responseTime" />
            <list:column property="clientIp" />
        </list:columns>
        <list:command id="refresh" />  
    </list:list>

    <list:list id="request-current-statistics" order-by="responseTime desc" search="name">
        <list:dao class="org.riotfamily.statistics.dao.CurrentRequestStatisticsDao" />
        <list:columns>
            <list:column property="name" sortable="true"/>
            <list:column property="timestamp" sortable="true" />
            <list:column property="responseTime" sortable="true" />
            <list:column property="clientIp" sortable="true" />
        </list:columns>
        <list:command id="refresh" /> 
    </list:list>

    <list:list id="response-faulty-statistics" order-by="count desc" search="name">
        <list:dao class="org.riotfamily.statistics.dao.FaultyResponsesStatisticsDao" />
        <list:columns>
            <list:column property="name" sortable="true"/>
            <list:column property="count" sortable="true"/>
            <list:column property="status" sortable="true"/>
            <list:column property="referer" sortable="true" />
            <list:column property="clientIp" sortable="true" />
            <list:column property="userAgent" sortable="true" />
        </list:columns>
        <list:command id="refresh" /> 
    </list:list>
    -->
    
</beans>

