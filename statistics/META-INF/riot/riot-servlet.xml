<?xml version="1.0" encoding="UTF-8"?>
<beans
	xmlns="http://www.springframework.org/schema/beans"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:override="http://www.riotfamily.org/schema/common/override"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
		http://www.springframework.org/schema/util
		http://www.springframework.org/schema/util/spring-util-3.0.xsd
		http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.riotfamily.org/schema/common/override
		http://www.riotfamily.org/schema/common/override-9.0.xsd">

	<!-- FilterPlugin to collect request statistics -->
	<bean id="requestCountFilterPlugin" class="org.riotfamily.statistics.web.RequestCountFilterPlugin">
		<property name="filterName" value="website-filter" />
        <property name="enabled" value="${riot.statistics.request.enabled=false}" />
        <property name="ignoreUploads" value="${riot.statistics.request.ignoreUploads=false}" />
        		        
        <!-- Requests with response times slower than 10000 ms are logged -->
        <property name="warnThreshold" value="${riot.statistics.request.warnThreshold=10000}" />

        <!-- When max. number of parallel requests is exceeded a failure is signaled to the monitoring system -->
        <property name="maxRequests" value="${riot.statistics.request.maxRequests=500}" />
        
        <!-- URL called by the monitoring system to ensure system health -->
        <property name="monitoredUrl" value="${riot.statistics.request.monitoredUrl=/status/application}" />
        
        <!-- Response status codes which should be monitored -->
        <property name="faultStatusCodes" value="${riot.statistics.request.faultStatusCodes=404,410,500}" />
    </bean>

	<bean id="requestTimestampRenderer" class="org.riotfamily.common.ui.DateRenderer">
		<property name="pattern" value="dd.MM.yy HH:mm:ss" />
	</bean>
	
    <!-- ================================================================== -->
    <!-- Module resources                                                   -->
    <!-- ================================================================== -->
        
    <override:add ref="resourceMappings" append="true">         
        <bean class="org.riotfamily.core.resource.ResourceMapping">
            <property name="path" value="/" />
            <property name="location" value="classpath:/org/riotfamily/statistics/runtime/resources/" />
        </bean>
    </override:add>    
        
    <override:add ref="messageBasenames" append="true">
		<value>classpath:/org/riotfamily/statistics/runtime/i18n/messages</value>
	</override:add>
    
    <override:add ref="customStyleSheets">
        <value>style/riot-statistics.css</value>
    </override:add>
     
 	<util:list id="packageListPatterns">
 		<value>org.riotfamily.*</value>
		<value>org.springframework.*</value>
		<value>org.hibernate.*</value>
		<value>java.*</value>
 	</util:list>
 	
 	<util:list id="statsColumns">
		<bean class="org.riotfamily.core.screen.list.ColumnConfig">
			<property name="property" value="name" />
		</bean>
		<bean class="org.riotfamily.core.screen.list.ColumnConfig">
			<property name="property" value="value" />
		</bean>
	</util:list>
 	
 	<override:add ref="systemScreens">
		
		<bean id="systemStatistics" class="org.riotfamily.core.screen.GroupScreen">
			<property name="icon" value="chart_curve" />
			<property name="childScreens">
				<list>
					<bean id="properties" class="org.riotfamily.core.screen.GroupScreen">
						<property name="childScreens">
							<list>	
					        	<bean id="systemProperties" class="org.riotfamily.core.screen.list.TreeListScreen">
						        	<property name="icon" value="table_gear" />
						        	<property name="dao">
										<bean class="org.riotfamily.statistics.dao.SystemPropertiesDao" />
									</property>
									<property name="columns" ref="statsColumns" />
					        	</bean>
					        	<bean id="environmentProperties" class="org.riotfamily.core.screen.list.TreeListScreen">
					        		<property name="icon" value="picture" />
					        		<property name="dao">
										<bean class="org.riotfamily.statistics.dao.EnvironmentPropertiesDao" />
									</property>
									<property name="columns" ref="statsColumns" />
					        	</bean>
					        	<!-- 
					        	<bean id="applicationProperties" class="org.riotfamily.core.screen.list.TreeListScreen">
					        		<property name="icon" value="cog" />
					        		<property name="dao">
					        			<bean class="org.riotfamily.statistics.dao.ResourcePropertiesDao">
								        	<property name="resource" value="classpath:/application.properties" />
        								</bean>
        							</property>
        							<property name="columns" ref="statsColumns" />
					        	</bean>
					        	-->
					        </list>
				       </property>
					</bean>
					
			        <bean id="riotModuleVersions" class="org.riotfamily.core.screen.list.TreeListScreen">
			        	<property name="icon" value="plugin" />
			        	<property name="dao">
			        		<bean class="org.riotfamily.statistics.dao.PackageListDao">
        						<property name="patterns" ref="packageListPatterns" />
        					</bean>
       					</property>
			        	<property name="columns" ref="statsColumns" />
				    </bean>
				    
				    <bean id="hibernateStatistics" class="org.riotfamily.core.screen.GroupScreen">
						<property name="icon" value="hibernate" />
						<property name="childScreens">
							<list>
					        	<bean id="hibernateCommonStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
					        		<property name="icon" value="chart_bar" />
					        		<property name="dao">
					        			<bean class="org.riotfamily.statistics.dao.HibernateStatisticsDao">
					        				<constructor-arg ref="sessionFactory" />
					        			</bean>
					        		</property>
					        		<property name="columns" ref="statsColumns" />
					        		<property name="commands">
					        			<list>
						        			<bean class="org.riotfamily.statistics.commands.ToggleHibernateStatisticsCommand">
						        				<constructor-arg ref="sessionFactory" />
						        				<property name="enablingCommand" value="true" />
						        			</bean>
						        			<bean class="org.riotfamily.statistics.commands.ToggleHibernateStatisticsCommand">
						        				<constructor-arg ref="sessionFactory" />
						        				<property name="enablingCommand" value="false" />
						        			</bean>
						        			<bean class="org.riotfamily.statistics.commands.ClearHibernateStatisticsBaselineCommand">
						        				<constructor-arg ref="sessionFactory" />
						        			</bean>
						        			<bean class="org.riotfamily.statistics.commands.RefreshListCommand" />
					        			</list>
					        		</property>
					        	</bean>
					        	<bean id="hibernateCacheStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
					        		<property name="dao">
					        			<bean class="org.riotfamily.statistics.dao.HibernateCacheStatisticsDao">
					        				<constructor-arg ref="sessionFactory" />
					        			</bean>
					        		</property>
					        		<property name="columns" ref="statsColumns" />
					        		<property name="commands">
					        			<bean class="org.riotfamily.statistics.commands.RefreshListCommand" />
					        		</property>
					        	</bean>
					        	<bean id="hibernateCacheRegions" class="org.riotfamily.core.screen.list.TreeListScreen">
					        		<property name="dao">
					        			<bean class="org.riotfamily.statistics.dao.HibernateCacheRegionDao">
					        				<constructor-arg ref="sessionFactory" />
					        			</bean>
					        		</property>
					        		<property name="icon" value="map" />
				        	 		<property name="columns">
						        	 	<util:list>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="name" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="elementsInMemory" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="elementsOnDisk" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="hitCount" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="missCount" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="putCount" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="kbInMemory" />
											</bean>
										</util:list>
				        	 		</property>
					        		<property name="commands">
					        			<bean class="org.riotfamily.statistics.commands.RefreshListCommand" />
					        		</property>
					        	</bean>
							</list>
						</property>
					</bean>
			        
			        <bean id="connectionPoolStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
			        	<property name="icon" value="database_connect" />
					    <property name="dao">
					    	<bean class="org.riotfamily.statistics.dao.C3P0StatisticsDao">
		        				<property name="dataSource" ref="riotDataSource" />
		        			</bean>
		        		</property>
		        		<property name="columns" ref="statsColumns" />
		        		<property name="commands">
		        			<bean class="org.riotfamily.statistics.commands.RefreshListCommand" />
		        		</property>
			        </bean>
			        
			        <bean id="runtimeStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
			        	<property name="icon" value="server_chart" />
			        	<property name="dao">
			        		<bean class="org.riotfamily.statistics.dao.RuntimeStatisticsDao" />
			        	</property>
			        	<property name="columns" ref="statsColumns" />
		        		<property name="commands">
		        			<list>
		        				<bean class="org.riotfamily.statistics.commands.PerformGarbageCollectionCommand" />
			        			<bean class="org.riotfamily.statistics.commands.RefreshListCommand" />
		        			</list>
		        		</property>
			        </bean>
			        
			        <bean id="requestStatistics" class="org.riotfamily.core.screen.GroupScreen">
						<property name="childScreens">
							<list>
						        <bean id="requestOverviewStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
						        	<property name="icon" value="chart_bar" />
						        	<property name="dao">
						        		<bean class="org.riotfamily.statistics.dao.RequestStatisticsDao">
						        			<constructor-arg ref="requestCountFilterPlugin" />
						        		</bean>
						        	</property>
						        	<property name="columns" ref="statsColumns" />
					        		<property name="commands">
					        			<list>
						        			<bean class="org.riotfamily.statistics.commands.ToggleRequestStatisticsCommand">
						        				<constructor-arg ref="requestCountFilterPlugin" />
						        				<property name="enablingCommand" value="true" />
						        			</bean>
						        			<bean class="org.riotfamily.statistics.commands.ToggleRequestStatisticsCommand">
						        				<constructor-arg ref="requestCountFilterPlugin" />
						        				<property name="enablingCommand" value="false" />
						        			</bean>
						        			<bean class="org.riotfamily.statistics.commands.ClearRequestStatisticsBaselineCommand">
						        				<constructor-arg ref="requestCountFilterPlugin" />
						        			</bean>
						        			<bean class="org.riotfamily.statistics.commands.RefreshListCommand" />
					        			</list>
					        		</property>
						        </bean>
					            <bean id="requestCriticalStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
					            	<property name="icon" value="hourglass" />
					            	<property name="dao">
					            		<bean class="org.riotfamily.statistics.dao.CriticalRequestStatisticsDao">
					            			<constructor-arg ref="requestCountFilterPlugin" />
					            		</bean>
						        	</property>
				        	 		<property name="columns">
						        	 	<list>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="name" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="timestamp" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="responseTime" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="clientIp" />
											</bean>
										</list>
				        	 		</property>
					        		<property name="commands">
					        			<bean class="org.riotfamily.statistics.commands.RefreshListCommand" />
					        		</property>
						        </bean>
						        <bean id="requestCurrentStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
						        	<property name="icon" value="time" />
						        	<property name="dao">
						        		<bean class="org.riotfamily.statistics.dao.CurrentRequestStatisticsDao">
						        			<constructor-arg ref="requestCountFilterPlugin" />
						        		</bean>
						        	</property>
				        	 		<property name="columns">
						        	 	<list>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="name" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="timestamp" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="responseTime" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="clientIp" />
											</bean>
										</list>
				        	 		</property>
					        		<property name="commands">
					        			<bean class="org.riotfamily.statistics.commands.RefreshListCommand" />
					        		</property>
						        </bean>
						        <bean id="requestFaultyStatistics" class="org.riotfamily.core.screen.list.TreeListScreen">
						        	<property name="icon" value="error" />
						        	<property name="dao">
						        		<bean class="org.riotfamily.statistics.dao.FaultyResponsesStatisticsDao">
						        			<constructor-arg ref="requestCountFilterPlugin" />
						        		</bean>
						        	</property>
				        	 		<property name="columns">
						        	 	<list>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="name" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="status" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="count" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="lastTime" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="referer" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="clientIp" />
											</bean>
											<bean class="org.riotfamily.core.screen.list.ColumnConfig">
												<property name="property" value="userAgent" />
											</bean>
										</list>
				        	 		</property>
					        		<property name="commands">
					        			<bean class="org.riotfamily.statistics.commands.RefreshListCommand" />
					        		</property>
						        </bean>
							</list>
						</property>
					</bean>
				</list>
			</property>
		</bean>
	</override:add>
		
	<!--
    
     <list:list id="cachius-statistics" order-by="" row-style-property="style">
        <list:dao class="org.riotfamily.statistics.dao.CachiusStatisticsDao">
        	<list:property name="cacheService" ref="cacheService" />
        </list:dao>
        <list:columns>
            <list:column property="name" />
            <list:column property="value" />
        </list:columns>
        <list:command id="refresh" />  
        <list:command class="org.riotfamily.statistics.commands.ResetCachiusStatisticsCommand" />
        <list:command class="org.riotfamily.statistics.commands.InvalidateCachiusCacheCommand" />
    </list:list>

    -->
    
</beans>

