<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:override="http://www.riotfamily.org/schema/common/override"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
		http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
		http://www.springframework.org/schema/util
		http://www.springframework.org/schema/util/spring-util-2.0.xsd
		http://www.riotfamily.org/schema/common/override
		http://www.riotfamily.org/schema/common/override-6.5.xsd">

	<!--
	  - Service bean to edit components. Exposed via DWR.
	  -->
	<bean id="componentEditor" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="interceptorNames"><value>matchAllTxInterceptor</value></property>
		<property name="target"><ref bean="componentEditorTarget" /></property>
	</bean>

	<bean id="componentEditorTarget" class="org.riotfamily.components.editor.ComponentEditorImpl">
		<constructor-arg ref="componentDao" />
		<constructor-arg ref="componentRepository" />
		<property name="editorConfigs">
			<map>
				<entry key="tinyMCE" value-ref="tinyMCE" />
			</map>
		</property>
	</bean>

	<bean id="instantComponentEditor" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="interceptorNames"><value>matchAllTxInterceptor</value></property>
		<property name="target">
			<bean parent="componentEditorTarget">
				<property name="instantPublish" value="true" />
			</bean>
		</property>
	</bean>

	<util:properties id="tinyMCE">
		<prop key="plugins">smartquotes,autocleanup,nospam</prop>
		<prop key="smartquotes_quoteStyle">de</prop>
		<prop key="smartquotes_cleanup">false</prop>
		<prop key="valid_elements">+a[href|target|name],-strong/b,-em/i,h3/h2/h1,h4/h5/h6,p,br,hr,ul,ol,li,blockquote,sub,sup,span[class&lt;mailto]</prop>
		<prop key="theme_advanced_container_buttons1">formatselect,bold,italic,sup,bullist,numlist,outdent,indent,hr,link,unlink,anchor,code,undo,redo,charmap</prop>
		<prop key="theme_advanced_blockformats">p,h3,h4</prop>
		<prop key="forced_root_block">p</prop>
	</util:properties>

	<!--
	  - FormRepository providing component property forms.
	  -->
	<bean id="componentFormRepository" class="org.riotfamily.components.editor.ComponentFormRepository">
		<constructor-arg ref="componentRepository" />
		<property name="config" value="/WEB-INF/website-config/component-forms.xml" />
		<property name="customElements" ref="customFormElements" />
		<property name="mimetypesMap" ref="fileTypeMap" />
		<property name="imageCropper" ref="imageCropper" />
	</bean>

	<!--
	  - Controller that renders forms to edit component properties.
	  -->
	<bean id="componentFormController"
		name="/components/form/@{formId}/@{containerId}"
		class="org.riotfamily.components.editor.ComponentFormController">
		<constructor-arg ref="componentFormRepository" />
		<constructor-arg ref="componentRepository" />
		<constructor-arg ref="componentDao" />
		<property name="formContextFactory" ref="formContextFactory" />
	</bean>

	<override:properties ref="loginFormController">
		<property name="viewName" value="classpath:org/riotfamily/components/runtime/view/login-form.ftl" />
	</override:properties>

	<!--
	  - Login-popup that is opend by the Riot-login bookmarklet.
	  -->
	<bean id="toolbarLoginFormController"
		name="/pages/login"
		class="org.riotfamily.riot.security.ui.LoginFormController">
		<constructor-arg ref="loginManager" />
		<property name="successViewName" value="classpath:/org/riotfamily/components/runtime/view/toolbar-login-success.ftl" />
	</bean>


	<!-- Overrides -->

	<override:add ref="messageBasenames">
		<value>classpath:/org/riotfamily/components/runtime/i18n/messages</value>
		<value>/WEB-INF/website-config/messages</value>
	</override:add>

	<override:add ref="loginInterceptor" property="excludes">
		<value>/pages/login</value>
	</override:add>
	
	<override:add ref="resourceController" property="filters">
		<bean class="org.riotfamily.common.web.resource.PropertyResourceFilter">
			<property name="match" value="/**/toolbar-loader.js" />
			<property name="propertiesMap">
				<map>
					<entry key="riotServletPrefix" value-ref="riotServletPrefix" />
				</map>
			</property>
		</bean>
		<bean class="org.riotfamily.common.web.resource.MessageResourceFilter">
			<property name="prefix" value="components." />
			<property name="matches">
				<list>
					<value>/**/toolbar.js</value>
					<value>/**/inplace.js</value>
					<value>/**/component.js</value>
				</list>
			</property>
		</bean>
	</override:add>
	
	<override:add ref="resourceController" property="mappings">
		<bean class="org.riotfamily.common.web.resource.ResourceMapping">
			<property name="path" value="/" />
			<property name="location" value="classpath:/org/riotfamily/components/runtime/resources/" />
		</bean>
	</override:add>	
	
	<override:add ref="dwrController" property="configurators">
		<bean class="org.riotfamily.common.web.dwr.SpringConfigurator">
			<property name="converterTypes">
				<props>
					<prop key="org.riotfamily.components.editor.TypeInfo">bean</prop>
				</props>
			</property>
			<property name="serviceBeans">
				<map>
					<entry key="ComponentEditor" value-ref="componentEditor" />
					<entry key="InstantComponentEditor" value-ref="instantComponentEditor" />
				</map>
			</property>
			<property name="serviceInterfaces">
				<list>
					<value>org.riotfamily.components.editor.ComponentEditor</value>
				</list>
			</property>
		</bean>
	</override:add>
	
	<!--
	  - RiotDao to list dirty ComponentLists.
	  -->
	<bean id="dirtyComponentListDao" class="org.riotfamily.components.dao.DirtyComponentListDao">
		<property name="componentDao" ref="componentDao" />
	</bean>

	<bean id="gotoComponentListCommand" class="org.riotfamily.components.command.GotoListCommand">
		<constructor-arg ref="componentRepository" />
		<property name="windowName" value="preview" />
	</bean>

</beans>